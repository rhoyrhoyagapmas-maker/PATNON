<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Patnon Shoe Care - Admin Dashboard</title>

  <link rel="icon" type="image/png" href="images/favicon.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f4f6f9;
      color: #333;
    }
    .navbar {
      background: linear-gradient(90deg, #007bff, #0056b3);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .navbar-brand { font-weight: 600; color: #fff !important; }
    .card {
      border-radius: 14px;
      border: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.08);
    }
    .card-header {
      background: linear-gradient(90deg, #007bff, #0056b3);
      color: #fff; font-weight: 600;
      border-top-left-radius: 14px;
      border-top-right-radius: 14px;
      letter-spacing: 0.3px;
    }
    footer {
      text-align: center;
      padding: 10px;
      margin-top: 30px;
      color: #777;
      font-size: 0.9rem;
    }

    /* ===== Enhanced Message Modal Styles ===== */
    #messageDetailsContent p {
      margin-bottom: .5rem;
      font-size: 0.95rem;
    }
    #messageDetailsContent strong {
      color: #0056b3;
    }
    #messageDetailsContent .message-text {
      background: #f8f9fa;
      border-left: 4px solid #007bff;
      padding: 1rem;
      border-radius: 6px;
      margin-top: 1rem;
      white-space: pre-wrap;
      line-height: 1.6;
      color: #333;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid px-4">
      <a class="navbar-brand" href="#">ðŸ§¼ Patnon Shoe Care - Admin</a>
      <div class="ms-auto d-flex">
        <button class="btn btn-outline-light me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#messagesOffcanvas">
          ðŸ“¨ Messages
          <span class="badge bg-light text-primary ms-1" id="message-count">0</span>
        </button>
        <button id="logout-button" class="btn btn-outline-light">Logout</button>
      </div>
    </div>
  </nav>

  <!-- OFFCANVAS: MESSAGES -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="messagesOffcanvas">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title">ðŸ“¨ Messages</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-0">
      <div id="loading-message" class="text-center py-3 d-none text-muted">Loading messages...</div>
      <div id="error-message" class="alert alert-danger d-none mb-0"></div>
      <div class="list-group list-group-flush" id="messages-list"></div>
    </div>
  </div>

  <main class="container py-4">
    <div class="row g-4">
      
      <!-- BOOKINGS -->
      <div class="col-lg-12">
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>ðŸ“… Bookings</span>
            <span class="badge bg-light text-primary" id="booking-count">0</span>
          </div>
          <div class="card-body p-0">
            <div id="loading-booking" class="text-center py-3 d-none text-muted">Loading bookings...</div>
            <div id="error-booking" class="alert alert-danger d-none"></div>
            <div class="table-responsive">
              <table class="table align-middle table-hover mb-0">
                <thead class="table-light">
                  <tr><th>Booked On</th><th>Customer</th><th>Service</th><th>Price</th><th class="text-center">Action</th></tr>
                </thead>
                <tbody id="bookings-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- VIDEOS -->
      <div class="col-lg-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>ðŸŽ¥ Manage Videos</span>
            <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addVideoModal">âž• Add Video</button>
          </div>
          <div class="card-body">
            <div id="videosList" class="row gy-3"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- MODAL: ADD VIDEO -->
  <div class="modal fade" id="addVideoModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content border-primary">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Add Facebook Video Embed</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">Facebook Embed URL</label>
          <input type="text" id="embedUrlInput" class="form-control" placeholder="https://www.facebook.com/plugins/video.php?...">
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" id="saveVideoBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: BOOKING DETAILS -->
  <div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content border-info">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title">Booking Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="detailsContent"></div>
        <div class="modal-footer border-info">
          <button id="delete-btn" class="btn btn-danger">Delete</button>
          <button class="btn btn-outline-info" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: MESSAGE DETAILS (Enhanced) -->
  <div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content shadow border-0">
        
        <div class="modal-header bg-gradient text-white" style="background: linear-gradient(90deg, #007bff, #0056b3);">
          <div>
            <h5 class="modal-title fw-semibold mb-0">ðŸ“¨ Message Details</h5>
            <small class="text-light-50">Review and manage customer messages</small>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body bg-light">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <div id="messageDetailsContent"></div>
            </div>
          </div>
        </div>

        <div class="modal-footer d-flex justify-content-between align-items-center">
          <span class="text-muted small">Patnon Shoe Care Admin</span>
          <div>
            <button id="delete-msg-btn" class="btn btn-danger btn-sm">ðŸ—‘ Delete</button>
            <button class="btn btn-outline-primary btn-sm" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>Â© 2025 Patnon Shoe Care. All Rights Reserved.</footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
  const SUPABASE_URL = 'https://ghvdkcakzoygktaiynae.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdodmRrY2Frem95Z2t0YWl5bmFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MjE4MTEsImV4cCI6MjA3ODA5NzgxMX0.9q3ak7TDEGApTsmrG8KGrMFhceg0qKL-KJD3Hthp0Mg';
  const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let messageModalInstance = null;

  document.addEventListener("DOMContentLoaded", () => {
    messageModalInstance = new bootstrap.Modal(document.getElementById("messageModal"));
    checkUserSession();
  });

  async function checkUserSession() {
    const { data } = await db.auth.getUser();
    if (!data.user) {
      window.location.href = 'admin-login.html';
    } else {
      fetchMessages();
      fetchBookings();
      fetchVideos();
    }
  }

  document.getElementById('logout-button').addEventListener('click', async () => {
    const { error } = await db.auth.signOut();
    if (!error) window.location.href = 'admin-login.html';
  });

  /* =================== ðŸ“¬ MESSAGES =================== */
  async function fetchMessages() {
    const loading = document.getElementById('loading-message');
    const count = document.getElementById('message-count');
    const errorBox = document.getElementById('error-message');
    const messagesList = document.getElementById('messages-list');

    loading.classList.remove('d-none');
    errorBox.classList.add('d-none');

    const { data, error } = await db.from('messagedb').select('*').order('created_at', { ascending: false });
    loading.classList.add('d-none');

    if (error) {
      errorBox.textContent = 'Error fetching messages: ' + error.message;
      errorBox.classList.remove('d-none');
      return;
    }

    count.textContent = data.length;
    messagesList.innerHTML = '';

    if (data.length === 0) {
      messagesList.innerHTML = `<div class="text-center p-3 text-muted">No messages found.</div>`;
      return;
    }

    data.forEach(msg => {
      const item = document.createElement('a');
      item.href = "#";
      item.className = "list-group-item list-group-item-action";
      item.innerHTML = `
        <div class="d-flex w-100 justify-content-between">
          <h6 class="mb-1">${msg.name}</h6>
          <small>${new Date(msg.created_at).toLocaleString()}</small>
        </div>
        <p class="mb-1"><strong>${msg.subject}</strong></p>
        <small>${msg.message.substring(0, 60)}...</small>
      `;
      item.addEventListener('click', () => showMessageModal(msg));
      messagesList.appendChild(item);
    });
  }

  function showMessageModal(msg) {
    const body = document.getElementById('messageDetailsContent');
    body.innerHTML = `
      <p><strong>Name:</strong> ${msg.name}</p>
      <p><strong>Email:</strong> ${msg.email || 'N/A'}</p>
      <p><strong>Subject:</strong> ${msg.subject}</p>
      <p><strong>Date:</strong> ${new Date(msg.created_at).toLocaleString()}</p>
      <hr>
      <div class="message-text">${msg.message}</div>
    `;
    messageModalInstance.show();
  }

  /* =================== ðŸ“… BOOKINGS =================== */
  async function fetchBookings() {
    const loading = document.getElementById('loading-booking');
    const count = document.getElementById('booking-count');
    const errorBox = document.getElementById('error-booking');
    const bookingsTbody = document.getElementById('bookings-tbody');

    loading.classList.remove('d-none');
    const { data, error } = await db.from('bookings').select('*').order('created_at', { ascending: false });
    loading.classList.add('d-none');

    if (error) {
      errorBox.textContent = 'Error fetching bookings: ' + error.message;
      errorBox.classList.remove('d-none');
      return;
    }

    count.textContent = data.length;
    bookingsTbody.innerHTML = '';

    if (data.length === 0) {
      bookingsTbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">No bookings found.</td></tr>';
      return;
    }

    bookingsTbody.innerHTML = data.map(b => `
      <tr>
        <td>${new Date(b.created_at).toLocaleDateString()}</td>
        <td>${b.customer_name}</td>
        <td>${b.service_name}</td>
        <td>â‚±${b.service_price}</td>
        <td class="text-center"><button class="btn btn-primary btn-sm" onclick='showDetailsModal(${JSON.stringify(b)}, "bookings")'>View</button></td>
      </tr>
    `).join('');
  }

  /* =================== ðŸŽ¥ VIDEOS (Embed Only) =================== */
  async function fetchVideos() {
    const videosList = document.getElementById('videosList');
    const { data, error } = await db.from('videos').select('*').order('created_at', { ascending: false });
    if (error) {
      videosList.innerHTML = `<p class="text-danger text-center">Error loading videos</p>`;
      return;
    }
    if (!data.length) {
      videosList.innerHTML = `<p class="text-center text-muted">No videos yet.</p>`;
      return;
    }

    videosList.innerHTML = data.map(v => `
      <div class="col-md-4">
        <div class="card shadow-sm border-0">
          <div class="card-body p-2">
            <iframe src="${v.embed_url}" class="w-100" height="250" style="border:none;border-radius:8px;"></iframe>
          </div>
          <div class="card-footer text-center">
            <button class="btn btn-danger btn-sm" onclick="deleteVideo(${v.id})">Delete</button>
          </div>
        </div>
      </div>
    `).join('');
  }

  async function addVideo() {
    const url = document.getElementById('embedUrlInput').value.trim();
    if (!url) return alert('Please enter a valid embed URL.');
    const { error } = await db.from('videos').insert([{ embed_url: url }]);
    if (error) alert('Error adding video: ' + error.message);
    else {
      alert('Video added successfully!');
      document.getElementById('embedUrlInput').value = '';
      bootstrap.Modal.getInstance(document.getElementById('addVideoModal')).hide();
      fetchVideos();
    }
  }

  async function deleteVideo(id) {
    if (!confirm('Delete this video?')) return;
    const { error } = await db.from('videos').delete().eq('id', id);
    if (error) alert('Error deleting video: ' + error.message);
    else { alert('Video deleted!'); fetchVideos(); }
  }

  document.getElementById('saveVideoBtn').addEventListener('click', addVideo);

  /* =================== UTILS =================== */
  function showDetailsModal(details, tableName) {
    const modalBody = document.getElementById('detailsContent');
    modalBody.innerHTML = Object.entries(details).map(([k, v]) => `<p><strong>${k}:</strong> ${v}</p>`).join('');
    new bootstrap.Modal(document.getElementById('detailsModal')).show();
  }
  </script>
</body>
</html>
